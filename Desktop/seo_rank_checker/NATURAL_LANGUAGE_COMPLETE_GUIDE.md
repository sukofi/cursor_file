# 🤖 Discord Bot 自然言語対話機能 - 完全ガイド

## 📋 目次

1. [概要](#概要)
2. [主要機能](#主要機能)
3. [使い方](#使い方)
4. [実践例](#実践例)
5. [高度な機能](#高度な機能)
6. [技術仕様](#技術仕様)
7. [トラブルシューティング](#トラブルシューティング)

---

## 📖 概要

SEO Rank Checker Bot は、Gemini AI を活用した高度な自然言語対話機能を搭載しています。

### 🎯 できること

✅ **コマンド不要** - 普通に話しかけるだけでOK  
✅ **意図理解** - 何をしたいか自動判断  
✅ **Google検索** - 最新情報をリアルタイム検索  
✅ **コード実行** - 計算や分析を自動実行  
✅ **会話記憶** - 文脈を理解した対話  
✅ **データ分析** - スプレッドシートを理解  

### 🆚 従来との違い

| 従来 | 新機能 |
|------|--------|
| `!rank` | 「順位をチェックして」 |
| `!analyze "KW" "URL"` | 「中古車買取を分析して」 |
| `!status` | 「今の設定は？」 |
| コマンドのみ | 自由な質問もOK |

---

## ⭐ 主要機能

### 1. 🎤 自然言語コマンド実行

コマンドを覚える必要なし！自然に話しかけるだけ。

#### 順位チェック

```
✅ 「順位をチェックして」
✅ 「今日のランキングを見せて」
✅ 「検索順位を確認したい」
✅ 「最初の10件だけチェックして」
✅ 「ランクチェック実行」
```

#### 競合分析

```
✅ 「中古車買取というキーワードを分析して」
✅ 「競合サイトを調べて」
✅ 「〇〇のURLで競合分析」
```

#### 設定確認

```
✅ 「設定を見せて」
✅ 「今の状態は？」
✅ 「ステータス確認」
```

#### ヘルプ

```
✅ 「使い方を教えて」
✅ 「何ができるの？」
✅ 「ヘルプを表示」
```

### 2. 🔍 Google検索機能

最新情報を自動的に検索して回答します。

```
質問例:
• 「最新のGoogle検索アルゴリズムについて教えて」
• 「2026年のSEOトレンドは？」
• 「ChatGPTの最新バージョンは？」
• 「今日の天気は？」
```

**Bot の動作:**
1. 質問を受け取る
2. Google検索が必要か判断
3. 自動的に検索実行
4. 結果をまとめて回答

### 3. 💻 コード実行機能

計算や分析を自動実行します。

```
質問例:
• 「CTRが3%でクリック数が150の場合、インプレッション数は？」
• 「月間検索数10,000でCTR2%、CVR5%の場合、予想CV数は？」
• 「フィボナッチ数列の最初の10個を教えて」
```

**Bot の動作:**
1. 質問から必要な計算を理解
2. Pythonコードを自動生成
3. 実行して結果を取得
4. わかりやすく説明

### 4. 📊 スプレッドシート分析

データベースやスプレッドシートの内容を理解します。

```
質問例:
• 「優先度が高いキーワードは何個ある？」
• 「カテゴリ別のキーワード数を教えて」
• 「中古車に関連するキーワードをリストアップ」
• 「最近追加されたキーワードは？」
```

### 5. 🧠 会話履歴の記憶

ユーザーごとに会話を記憶（最大10メッセージ）。

```
例:
ユーザー: 「Pythonについて教えて」
Bot: 「Pythonは...」

ユーザー: 「それでWebスクレイピングするには？」
           ↑「それ」= Python と理解
Bot: 「Pythonでのスクレイピングには...」
```

### 6. 💬 SEO専門知識

SEOに関する質問に詳しく回答。

```
質問例:
• 「SEOって何？」
• 「タイトルタグの最適な文字数は？」
• 「内部リンクの効果的な貼り方は？」
• 「モバイルファーストインデックスとは？」
• 「被リンクを増やす方法は？」
```

---

## 🎯 使い方

### 基本的な使い方

#### 方法1: メンション

サーバーの任意のチャンネルで：

```
@SEO Reporter こんにちは！
@SEO Reporter 順位をチェックして
@SEO Reporter SEOについて教えて
```

#### 方法2: DM（ダイレクトメッセージ）

Botに直接メッセージ：

```
こんにちは！
順位をチェックして
最近のSEOトレンドは？
```

#### 方法3: 従来のコマンド（引き続き使用可能）

```
!rank
!rank 10
!analyze "キーワード" "URL"
!status
!usage
```

### 話しかけ方のコツ

#### ✅ 良い例

```
✅ 「中古車買取の順位をチェックして」
   → 具体的で明確

✅ 「最新のGoogle検索アルゴリズムについて教えて」
   → 質問の意図が明確

✅ 「CTRが3%でクリック150の場合のインプレッション数は？」
   → 必要な情報が含まれている
```

#### ❌ 悪い例

```
❌ 「それについて」
   → 何を指しているか不明確

❌ 「どうすればいい？」
   → 状況が不明

❌ 「あれ」
   → 曖昧すぎる
```

---

## 💡 実践例

### 例1: 順位チェックの実行

```
ユーザー: @SEO Reporter 順位チェックしたい

Bot: 📊 わかりました！順位チェックを開始します...

Bot: 📥 スプレッドシートからキーワードを取得中...

Bot: ✅ 152件のキーワードを取得しました

Bot: 🔍 順位チェックを実行中... (これには数分かかる場合があります)

[数分後]

Bot: [結果のEmbed表示]
     📊 順位チェック結果
     実行日時: 2026-02-03 14:30
     📉 順位下落: 5件
     🚫 圏外落ち: 2件
```

### 例2: SEOについて学ぶ

```
ユーザー: @SEO Reporter SEOって何？

Bot: SEO（Search Engine Optimization：検索エンジン最適化）とは、
     Googleなどの検索エンジンで自分のWebサイトを上位表示させるための
     施策のことです。

     主な要素:
     1. コンテンツの質
     2. キーワード戦略
     3. 内部リンク構造
     4. 外部リンク（被リンク）
     5. ページ速度
     6. モバイル対応

     何か具体的に知りたいことはありますか？

─────────────────────────────

ユーザー: 被リンクを増やす方法は？

Bot: 被リンク（バックリンク）を増やす効果的な方法をご紹介します：

     【自然な被リンク獲得】
     1. 高品質なコンテンツを作成
        - 独自の調査データ
        - 詳細なガイド記事
        - インフォグラフィック

     2. ゲスト投稿
        - 関連性の高いサイトに寄稿
        - 専門知識を共有

     3. SNSでの拡散
        - Twitter、LinkedIn等で共有
        - インフルエンサーへのアプローチ

     【注意点】
     ❌ 避けるべき: リンク購入、スパムリンク
     ✅ 推奨: 自然で質の高いリンク

     具体的な施策について詳しく知りたいですか？
```

### 例3: 最新情報の検索

```
ユーザー: @SEO Reporter 2026年のSEOトレンドを教えて

Bot: 2026年のSEOトレンドについて調べました。

     【主要トレンド】

     1. **AI生成コンテンツの品質評価**
        Googleは単なるAI生成ではなく、人間の経験や専門知識が
        加わったコンテンツを高く評価しています。

     2. **E-E-A-T の重要性増大**
        Experience（経験）が新たに追加され、実体験に基づく
        コンテンツが重視されています。

     3. **検索生成体験（SGE）の影響**
        AI要約が検索結果に表示され、クリック率に影響。
        より詳細で独自性のあるコンテンツが求められます。

     4. **動画コンテンツの重要性**
        YouTube SEOとの統合が進み、動画コンテンツの
        最適化が必須になっています。

     5. **ローカルSEOの進化**
        「Near me」検索の増加に伴い、地域密着型の
        最適化が重要です。

     [Google検索から取得した最新情報]

     何か具体的に知りたいトレンドはありますか？
```

### 例4: データ分析

```
ユーザー: @SEO Reporter スプレッドシートのデータを分析して

Bot: スプレッドシートを分析しました。

     📊 **データサマリー**
     - 総キーワード数: 150個
     - カテゴリ数: 5個
     - 優先度「高」: 23個（15%）
     - 優先度「中」: 87個（58%）
     - 優先度「低」: 40個（27%）

     📈 **カテゴリ別分析**
     1. 買取: 45個（30%）- 最多
     2. 査定: 38個（25%）
     3. 売却: 32個（21%）
     4. 廃車: 20個（13%）
     5. その他: 15個（10%）

     💡 **推奨アクション**
     1. 優先度「高」の23個を最優先で対策
     2. 「買取」カテゴリが最多なので、ここに注力
     3. 「廃車」カテゴリは少ないが、競合が少ない可能性

     詳しく知りたいカテゴリはありますか？
```

### 例5: 計算の実行

```
ユーザー: @SEO Reporter CTRが3%でクリック数が150の場合、
          インプレッション数は？

Bot: 計算しました！

     CTR 3%、クリック数 150の場合：
     インプレッション数 = 150 ÷ 0.03 = 5,000

     つまり、5,000回表示されて150回クリックされたことになります。

     【参考】
     CTR（Click Through Rate）= クリック数 ÷ インプレッション数
     
     他に計算したいことはありますか？
```

### 例6: 連続した質問

```
ユーザー: @SEO Reporter Pythonについて教えて

Bot: Pythonは、シンプルで読みやすい構文が特徴のプログラミング言語です...

─────────────────────────────

ユーザー: それでWebスクレイピングするには？
          ↑「それ」= Python と理解

Bot: PythonでのWebスクレイピングには、主に以下のライブラリを使います：

     1. **Beautiful Soup** - HTMLの解析
     2. **Requests** - Webページの取得
     3. **Selenium** - JavaScript対応

     基本的な流れ:
     ```python
     import requests
     from bs4 import BeautifulSoup

     # Webページを取得
     response = requests.get('https://example.com')
     soup = BeautifulSoup(response.text, 'html.parser')

     # データを抽出
     titles = soup.find_all('h1')
     ```

     サンプルコードを見せましょうか？

─────────────────────────────

ユーザー: はい、お願いします

Bot: わかりました。実際に動くサンプルコードです...
```

---

## 🚀 高度な機能

### 1. 複合的な質問

複数の要素を含む質問も可能：

```
@SEO Reporter 「中古車買取」のキーワードで、
競合サイトの特徴を調べて、
うちのサイトとの差を分析して、
改善案を提案して
```

### 2. 条件付き実行

条件を指定して実行：

```
@SEO Reporter 優先度が高いキーワードだけチェックして
@SEO Reporter 最初の5件だけ競合分析して
```

### 3. 定期的な質問

定期的な情報確認：

```
@SEO Reporter 先週と比べて順位はどう変わった？
@SEO Reporter 今月追加したキーワードの状況は？
```

### 4. データのフィルタリング

特定の条件でデータを抽出：

```
@SEO Reporter 「買取」カテゴリで順位が下がったキーワードは？
@SEO Reporter 文字数が2000文字以下の記事は？
```

---

## 🔧 技術仕様

### アーキテクチャ

```
ユーザーメッセージ
    ↓
discord_bot.py (on_message)
    ↓
コマンド判定
    ├─ !で始まる → 従来のコマンド処理
    └─ それ以外 → 自然言語処理
         ↓
handle_natural_language()
    ↓
ai_analyzer.py
    ├─ understand_user_intent()  # 意図理解
    ├─ chat_with_tools()         # Google検索・コード実行
    └─ _fallback_intent_detection()  # フォールバック
    ↓
execute_intent()
    ├─ rank_check → 順位チェック実行
    ├─ analyze → 競合分析実行
    ├─ status → 設定表示
    ├─ help → ヘルプ表示
    ├─ greeting → 挨拶
    └─ question → AI回答
```

### 使用技術

| 技術 | 用途 |
|------|------|
| **Gemini 2.5 Flash** | 自然言語理解、会話生成 |
| **Google Search Grounding** | リアルタイム情報検索 |
| **Code Execution** | 計算・分析の実行 |
| **Discord.py** | Bot フレームワーク |
| **SQLite** | データベース |

### 意図判定の仕組み

#### 1. Gemini による判定（優先）

```python
# AI が自動的に意図を理解
response = gemini.understand_user_intent(user_message, context)

# 返却される意図の例
{
    'intent': 'rank_check',
    'confidence': 0.95,
    'parameters': {
        'limit': 10  # オプションのパラメータ
    }
}
```

#### 2. フォールバック判定（Gemini が使えない場合）

```python
# キーワードマッチング
if any(word in message for word in ['順位', 'チェック', 'ランク']):
    return {'intent': 'rank_check', 'confidence': 0.8}
```

### 会話履歴の管理

```python
# ユーザーごとに履歴を保持
conversation_history = {
    'user_id_123': [
        {'role': 'user', 'content': 'こんにちは'},
        {'role': 'assistant', 'content': 'こんにちは！...'},
        # ... 最大10件
    ]
}
```

---

## ⚙️ 設定

### 必要な環境変数

`.env` ファイル：

```bash
# 必須
DISCORD_BOT_TOKEN=your_bot_token_here
GEMINI_API_KEY=your_gemini_api_key_here

# オプション
DATAFORSEO_LOGIN=your_dataforseo_login
DATAFORSEO_PASSWORD=your_dataforseo_password
```

### config/settings.yaml

```yaml
# AI Analysis settings
enable_ai_analysis: true
gemini_model: "gemini-2.5-flash"  # 推奨モデル
```

### Botの起動

```bash
python discord_bot.py
```

起動ログ：
```
[INFO] SEO Reporter#1234 としてログインしました
[INFO] 自然言語対話モード: 有効
[INFO] コマンド: !rank, !status, !usage, !analyze
============================================================
```

---

## 🐛 トラブルシューティング

### Q: Bot が応答しない

**原因:**
- メンションしていない
- DMを送っていない
- Bot権限が不足

**対処法:**
1. `@Bot名` でメンション
2. DMで直接送信
3. コマンド`!help`で動作確認

### Q: AI機能が使えない

**原因:**
- Gemini API キーが未設定
- APIクォータ超過

**対処法:**
1. `.env`の`GEMINI_API_KEY`を確認
2. [Google AI Studio](https://makersuite.google.com/app/apikey)でキー確認
3. フォールバック機能は動作します

### Q: Google検索が使われない

**原因:**
- 質問が最新情報を必要としないと判断された

**対処法:**
- 「最新の〜」「今の〜」と明示的に指定

### Q: 応答が遅い

**原因:**
- Google検索実行中
- コード実行中
- API混雑

**対処法:**
- タイピングインジケーター表示中は待機
- 通常10〜30秒程度

### Q: 会話の文脈がおかしい

**原因:**
- 会話履歴の混乱
- 別の話題が混ざっている

**対処法:**
- 「話題を変えて」と明示
- 具体的に質問し直す

---

## 📊 制限事項

| 項目 | 制限 |
|------|------|
| メッセージ長 | 最大2000文字（Discord制限） |
| 会話履歴 | ユーザーごと最大10件 |
| Google検索 | Gemini APIの制限に依存 |
| コード実行時間 | 通常数秒 |
| 同時実行 | Bot全体で1処理ずつ |

---

## 💡 ベストプラクティス

### 1. 明確な質問

❌ **悪い例:**
```
「それについて」
「どうすればいい？」
```

✅ **良い例:**
```
「タイトルタグの最適化について教えて」
「順位が下がったキーワードの対策方法は？」
```

### 2. 段階的な質問

複雑な質問は分割して：

```
1. 「SEOの基本を教えて」
2. 「その中で、内部リンクについて詳しく」
3. 「具体的な実装方法は？」
```

### 3. フィードバックの活用

```
「もっと詳しく教えて」
「具体例を見せて」
「初心者向けに説明して」
```

### 4. 文脈の提供

```
❌ 「これでいい？」
✅ 「このタイトルタグ『中古車買取｜全国対応』はSEO的にどう？」
```

---

## 📚 関連ドキュメント

- [README.md](README.md) - プロジェクト全体
- [CHAT_GUIDE.md](CHAT_GUIDE.md) - 基本的なチャット機能
- [DISCORD_NOTIFICATION_GUIDE.md](DISCORD_NOTIFICATION_GUIDE.md) - Discord通知
- [COMPETITOR_ANALYSIS_GUIDE.md](COMPETITOR_ANALYSIS_GUIDE.md) - 競合分析

---

**最終更新**: 2026年2月3日  
**バージョン**: v2.2  
**機能**: Gemini 2.5 Flash + Google Search + Code Execution
