{% extends "base.html" %}

{% block title %}CSVインポート - SEO順位チェッカー{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- インポートカード -->
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="bi bi-file-earmark-arrow-up me-2"></i>CSV一括インポート
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data">
                        <!-- ファイル選択 -->
                        <div class="mb-4">
                            <label for="csv_file" class="form-label fw-bold">
                                <i class="bi bi-file-earmark-text me-2"></i>CSVファイルを選択
                            </label>
                            <input type="file" 
                                   class="form-control form-control-lg" 
                                   id="csv_file" 
                                   name="csv_file" 
                                   accept=".csv"
                                   required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                最大ファイルサイズ: 16MB
                            </div>
                        </div>

                        <!-- 列マッピング設定 -->
                        <div class="border rounded p-4 mb-4 bg-light">
                            <h5 class="mb-3">
                                <i class="bi bi-table me-2"></i>列のマッピング設定
                            </h5>
                            <p class="text-muted small">
                                CSVファイルの列名を指定してください。デフォルト値が設定されています。
                            </p>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="genre_column" class="form-label">ジャンル列</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="genre_column" 
                                           name="genre_column" 
                                           value="ジャンル"
                                           placeholder="ジャンル">
                                    <div class="form-text">例: ジャンル, genre</div>
                                </div>

                                <div class="col-md-4">
                                    <label for="keyword_column" class="form-label">キーワード列</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="keyword_column" 
                                           name="keyword_column" 
                                           value="KW"
                                           placeholder="KW">
                                    <div class="form-text">例: KW, keyword</div>
                                </div>

                                <div class="col-md-4">
                                    <label for="url_column" class="form-label">URL列（任意）</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="url_column" 
                                           name="url_column" 
                                           value="URL"
                                           placeholder="URL">
                                    <div class="form-text">例: URL, url</div>
                                </div>
                            </div>
                        </div>

                        <!-- CSV形式例 -->
                        <div class="border rounded p-4 mb-4">
                            <h5 class="mb-3">
                                <i class="bi bi-lightbulb me-2"></i>CSV形式の例
                            </h5>
                            
                            <p class="text-muted small mb-2">以下のようなCSV形式に対応しています：</p>
                            
                            <div class="bg-dark text-light p-3 rounded mb-3" style="font-family: 'Courier New', monospace; font-size: 0.9rem;">
                                <div>ジャンル,KW,URL</div>
                                <div>時計,ロレックス デイトナ,https://example.com/rolex-daytona</div>
                                <div>時計,オメガ スピードマスター,https://example.com/omega-speedmaster</div>
                                <div>金・貴金属,プラチナ 買取,https://example.com/platinum</div>
                                <div>金・貴金属,金 相場,</div>
                            </div>

                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>注意事項：</strong>
                                <ul class="mb-0 mt-2">
                                    <li>1行目が空の場合、2行目をヘッダーとして認識します</li>
                                    <li>URL列は任意です（空欄でもOK）</li>
                                    <li>既存のキーワードは上書きされます</li>
                                    <li>UTF-8エンコーディングを推奨します</li>
                                </ul>
                            </div>
                        </div>

                        <!-- アクションボタン -->
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>キャンセル
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-upload me-2"></i>インポート実行
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 使い方ガイド -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="mb-3">
                        <i class="bi bi-question-circle me-2"></i>使い方
                    </h5>
                    <ol class="mb-0">
                        <li class="mb-2">
                            <strong>CSVファイルを準備：</strong>
                            Excel、Google スプレッドシート、テキストエディタなどでCSVファイルを作成します
                        </li>
                        <li class="mb-2">
                            <strong>ファイルを選択：</strong>
                            上の「CSVファイルを選択」ボタンからファイルをアップロードします
                        </li>
                        <li class="mb-2">
                            <strong>列名を確認：</strong>
                            CSVファイルの列名がデフォルト値（ジャンル、KW、URL）と異なる場合は変更します
                        </li>
                        <li class="mb-2">
                            <strong>インポート実行：</strong>
                            「インポート実行」ボタンをクリックしてデータをインポートします
                        </li>
                    </ol>
                </div>
            </div>

            <!-- ヒント -->
            <div class="alert alert-success mt-4">
                <i class="bi bi-lightbulb-fill me-2"></i>
                <strong>ヒント：</strong>
                GoogleスプレッドシートからCSVをエクスポートする場合は、
                「ファイル」→「ダウンロード」→「カンマ区切り形式（.csv）」を選択してください。
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ファイル選択時にファイル名を表示
    document.getElementById('csv_file')?.addEventListener('change', function(e) {
        const fileName = e.target.files[0]?.name;
        if (fileName) {
            console.log('選択されたファイル:', fileName);
        }
    });

    // フォーム送信前の確認
    document.querySelector('form')?.addEventListener('submit', function(e) {
        const fileInput = document.getElementById('csv_file');
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('CSVファイルを選択してください');
            return;
        }

        const file = fileInput.files[0];
        const maxSize = 16 * 1024 * 1024; // 16MB

        if (file.size > maxSize) {
            e.preventDefault();
            alert('ファイルサイズが大きすぎます（最大16MB）');
            return;
        }

        if (!file.name.endsWith('.csv')) {
            e.preventDefault();
            alert('CSVファイルを選択してください');
            return;
        }

        // 確認ダイアログ
        const confirmation = confirm(`${file.name} をインポートしますか？\n既存のキーワードは上書きされます。`);
        if (!confirmation) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}
