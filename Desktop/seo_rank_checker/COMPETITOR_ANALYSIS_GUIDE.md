# 📉 順位下落時の自動競合差分分析ガイド

このガイドでは、順位が下落したキーワードに対して自動的に実行される競合差分分析機能について説明します。

## 📋 概要

順位チェック実行時、順位が下落したキーワードについて、自動的に以下の分析を実行します：

- **自社記事 vs 競合平均**の比較
- **見出し数、文字数、画像数、内部リンク数**の差分計算
- **改善提案**の自動生成
- **Discord通知**に差分レポートを含めて送信

## ⚙️ 設定方法

### 1. config/settings.yaml の設定

```yaml
# Competitor Analysis settings
enable_competitor_analysis: true  # 下落時に競合分析を自動実行
max_competitor_analysis_keywords: 5  # 競合分析を実行する下落キーワードの最大数（上位N件）
use_selenium: true  # JavaScript対応のためSeleniumを使用
```

### 2. 前提条件

#### Seleniumのインストール（推奨）

```bash
pip install selenium beautifulsoup4
```

#### ChromeDriverのインストール

**macOS:**
```bash
brew install chromedriver
```

**または、Seleniumが自動的にダウンロード**（Chrome/Chromiumがインストール済みの場合）

## 🚀 使い方

### 方法1: コマンドライン実行

```bash
# 全キーワードをチェック（下落したキーワードの競合分析を自動実行）
python main.py

# 特定のジャンルのみチェック
python main.py --genre "買取"
```

### 方法2: Discord Bot

```
!rank          # 全キーワードをチェック
!rank 10       # 最初の10件のみチェック
```

## 📊 分析の流れ

1. **順位チェック実行**
   - DataForSEO APIでGoogle検索順位を取得
   - 前回順位と比較して下落を検出

2. **下落キーワードを優先順位付け**
   - 下落幅が大きい順にソート
   - 上位N件（デフォルト: 5件）を選択

3. **各キーワードについて競合分析**
   - 自社URLの内容を分析
   - 上位3位の競合URLの内容を分析
   - 平均値を計算して比較

4. **Discord通知**
   - 下落キーワードの情報
   - 競合との差分レポート
   - 改善提案

## 📈 分析項目

| 項目 | 説明 |
|-----|------|
| **見出し数** | H1-H6タグの総数 |
| **文字数** | 本文の総文字数（scriptやstyleタグを除外） |
| **画像数** | imgタグの総数 |
| **内部リンク数** | 同一ドメイン内へのリンク数 |

## 💡 改善提案の基準

分析結果に基づいて、以下の基準で改善提案を生成します：

| 項目 | 改善提案の条件 |
|-----|--------------|
| **見出し** | 競合より2個以上少ない場合 |
| **文字数** | 競合より500文字以上少ない場合 |
| **画像** | 競合より2枚以上少ない場合 |
| **内部リンク** | 競合より3個以上少ない場合 |

## 📝 Discord通知の例

```
**キーワード**: `中古車 買取 相場`
**順位変動**: 3位 → 7位 (▼4)
**自社URL**: https://daikichi-kaitori.jp/car/souba

**上位競合**:
  1位: https://competitor1.com/car-kaitori
  2位: https://competitor2.com/car-assessment

**📊 競合との差分分析**:
```
項目          自社  競合平均  差分
----------------------------------------
見出し数        12      18.3     -6
文字数       2,500   4,200  -1,700
画像数           8      12.7     -5
内部リンク      15      22.3     -7
```

**💡 改善提案**:
  • 見出しを約6個追加
  • 約1,700文字のコンテンツを追加
  • 画像を約5枚追加
  • 内部リンクを約7個追加
```

## 🔧 トラブルシューティング

### Seleniumが動作しない

```yaml
# settings.yamlでSeleniumを無効化（requestsのみ使用）
use_selenium: false
```

ただし、JavaScriptでレンダリングされるページは正確に分析できない場合があります。

### ChromeDriverのエラー

```bash
# macOSの場合、セキュリティ設定を確認
# システム環境設定 → セキュリティとプライバシー → 許可

# または、最新版をインストール
brew upgrade chromedriver
```

### 分析に時間がかかりすぎる

```yaml
# 分析するキーワード数を減らす
max_competitor_analysis_keywords: 3  # 5 → 3に変更
```

### 競合分析を無効化したい

```yaml
# 競合分析を無効化
enable_competitor_analysis: false
```

## 📊 パフォーマンス

- **分析時間**: 1キーワードあたり約30秒〜1分
- **5キーワード**: 約2.5分〜5分
- **API消費**: DataForSEO APIのクレジットは順位チェック時のみ消費（分析時は消費しない）

## ⚠️ 注意事項

1. **順位下落時のみ実行**
   - 順位が下がったキーワードのみ分析します
   - 順位が上昇・維持された場合は分析しません

2. **下落幅の大きいキーワードを優先**
   - 3位→10位（▼7）のような大きな下落を優先的に分析
   - 5位→6位（▼1）のような小さな下落は後回し

3. **上位3件の競合のみ比較**
   - 1位〜3位の競合サイトを分析対象とします
   - 自社より下位の競合は分析しません

4. **JavaScript対応**
   - `use_selenium: true`の場合、JavaScriptで動的に生成されるコンテンツも分析可能
   - `use_selenium: false`の場合、静的HTMLのみ分析

## 🎯 ベストプラクティス

1. **定期的な順位チェック**
   - 週1回の実行を推奨
   - cron/launchdで自動化

2. **ジャンル別チェック**
   - 重要なジャンルは個別にチェック
   ```bash
   python main.py --genre "買取"
   ```

3. **Discord通知の確認**
   - 改善提案を元にコンテンツを改善
   - 優先度の高いキーワードから対応

4. **AI分析との併用**
   - AI分析（`enable_ai_analysis: true`）も有効化
   - トレンド分析と具体的な改善提案を両方活用

## 📚 関連ドキュメント

- [README.md](README.md) - 基本的な使い方
- [SPREADSHEET_GUIDE.md](SPREADSHEET_GUIDE.md) - スプレッドシート連携
- [DATABASE_GUIDE.md](DATABASE_GUIDE.md) - データベース管理

---

**作成日**: 2026-02-03
**バージョン**: v2.2
